name: Discord Dev-Log

on:
  push:
    branches: [main]

jobs:
  post-devlog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Post to Discord #dev-updates
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          FILES_CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l | tr -d ' ')
          python3 - <<'PYEOF'
import os, json, urllib.request, sys

token     = os.environ["DISCORD_BOT_TOKEN"]
sha       = os.environ["COMMIT_SHA"][:7]
msg       = os.environ["COMMIT_MSG"].split("\n")[0]   # first line only
author    = os.environ["COMMIT_AUTHOR"]
repo      = os.environ["REPO"]
branch    = os.environ["BRANCH"]
ts        = os.environ["COMMIT_TIMESTAMP"]
files     = os.environ.get("FILES_CHANGED", "?")
url       = f"https://github.com/{repo}/commit/{os.environ['COMMIT_SHA']}"
channel   = "1475632213037944912"

payload = json.dumps({
    "embeds": [{
        "title": "\U0001f527 New Push \u2014 Steel Eternal",
        "color": 15964171,
        "fields": [
            {"name": "Branch",        "value": f"`{branch}`",                     "inline": True},
            {"name": "Files changed", "value": files,                             "inline": True},
            {"name": "Author",        "value": author,                            "inline": True},
            {"name": "Commit",        "value": f"`{sha}` \u2014 {msg}\n[View on GitHub]({url})", "inline": False},
        ],
        "footer": {"text": repo},
        "timestamp": ts,
    }]
}).encode()

req = urllib.request.Request(
    f"https://discord.com/api/v10/channels/{channel}/messages",
    data=payload,
    headers={"Authorization": f"Bot {token}", "Content-Type": "application/json"},
    method="POST"
)
try:
    with urllib.request.urlopen(req) as r:
        print(f"Discord post OK â€” HTTP {r.status}")
except urllib.error.HTTPError as e:
    body = e.read().decode()
    print(f"::error::Discord post failed HTTP {e.code}: {body}")
    sys.exit(1)
PYEOF
