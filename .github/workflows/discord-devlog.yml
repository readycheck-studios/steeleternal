name: Discord Dev-Log

on:
  push:
    branches: [main]

jobs:
  post-devlog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Post to Discord #dev-updates
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          CHANNEL_ID="1475632213037944912"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_URL="https://github.com/${REPO}/commit/${COMMIT_SHA}"
          FILES_CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l | tr -d ' ')

          PAYLOAD=$(jq -n \
            --arg branch "$BRANCH" \
            --arg files "$FILES_CHANGED" \
            --arg author "$COMMIT_AUTHOR" \
            --arg sha "$SHORT_SHA" \
            --arg url "$COMMIT_URL" \
            --arg msg "$COMMIT_MSG" \
            --arg repo "$REPO" \
            --arg ts "$COMMIT_TIMESTAMP" \
            '{
              embeds: [{
                title: "ðŸ”§ New Push â€” Steel Eternal",
                color: 15964171,
                fields: [
                  {name: "Branch",        value: ("`" + $branch + "`"), inline: true},
                  {name: "Files changed", value: $files,                inline: true},
                  {name: "Author",        value: $author,               inline: true},
                  {name: "Commit",        value: ("`" + $sha + "` â€” " + $msg + "\n[View on GitHub](" + $url + ")"), inline: false}
                ],
                footer: {text: $repo},
                timestamp: $ts
              }]
            }')

          HTTP_STATUS=$(curl -s -o /tmp/discord_response.json -w "%{http_code}" -X POST \
            "https://discord.com/api/v10/channels/${CHANNEL_ID}/messages" \
            -H "Authorization: Bot ${DISCORD_BOT_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Discord API status: $HTTP_STATUS"
          cat /tmp/discord_response.json

          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "::error::Discord post failed with HTTP $HTTP_STATUS"
            exit 1
          fi
